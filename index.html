<html>
  <head>
    <title>RPS Versus Computer</title>
    <meta property="og:title" content="RPS Versus Computer">
    <meta property="og:image" content="https://i.sstatic.net/xFp3TeOi.png">
    <meta property="og:description" content="Play the classic Rock Paper Scissors against the Computer that LEARNS your patterns">
    <script src="https://unpkg.com/brain.js"></script>
    <style>
      body{
        background-color: lightgrey;
      }
      #dialogue {
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 20vh;
        font-size: 2.1em;
      }
      .rps{
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
      }
      .rps img{
        height: 70vh;
        width: 30vw;
        object-fit: contain;
        display: block;
        margin: 0 auto;
      }
      .disabled{
        cursor: not-allowed;
        opacity: 0.4;
        pointer-events: none;
      }
    </style>
    <script>

if(localStorage.getItem('version')!=="0.0.1") localStorage.clear();
localStorage.setItem('version','0.0.1')
const net = new brain.recurrent.LSTM({outputSize:1});
let gameplay = localStorage.getItem('gameplay')||"", pScore=0, cScore=0, round=0
const opposite = {R:'P', P:'S', S:'R'}, words={R:'rock', P:'paper', S:'scissors'}
const training = gameplay? JSON.parse(localStorage.getItem('brain')): []
if(gameplay) net.train(training.slice(-16), {iterations:100});

let take_turn=function(data){} //will be replaced by the promise resolver function of a turn
async function player_prompt(text){
  player_alert(text)
  return new Promise(resolver=>take_turn=resolver)
}
function player_alert(text){
  let dialogue = document.getElementById('dialogue')
  dialogue.innerText=text
}
async function artificial_wait_time(){
  document.querySelectorAll(".rps").forEach(function(button){
    button.classList.add("disabled")
    button.title="Still Processing Game Turn"
  })
  return new Promise(r=>setTimeout(r,3e3)) //artificial wait time
}
function round_ready(){
  round++
  if(Number(localStorage.getItem('round'))<round)
    localStorage.setItem('round',round.toString());
  document.querySelectorAll(".rps").forEach(function(button){
    button.classList.remove("disabled")
    button.removeAttribute("title")
  })
}

function displayWinner(p,c,stumped){
  let text=`Player chose ${words[p]}, Computer chose ${words[c]}\n`
  if(stumped) text="Computer didn't think this time, it guessed\n"+text;
  if(p==c) text+="DRAW!";
  else if(opposite[c]==p) (pScore++, text+="Player WINS!");
  else (cScore++, text+="Computer WINS!");
  player_alert(text+"\nPlease wait for next round...")
}
function randomChoice(){
  return Object.keys(opposite)[Math.floor(Math.random()*3)]
};

window.onload = async function(){
  while(true){
    round_ready()
    let prev=gameplay
    let stumped=round<3 && Number(localStorage.getItem('round'))<3
    let scores=`Player Score: ${pScore}    -    Computer Score: ${cScore}`
    let player_choice = await player_prompt(`Round ${round}\n${scores}\nPlay: R, P, or S`)
    if(!opposite[player_choice]) player_choice = randomChoice(); //make choice if nothing valid
    let computer_choice = stumped? randomChoice(): opposite[net.run(gameplay.slice(-8))]
    if(!computer_choice) (stumped=true, computer_choice=randomChoice()); //make choice if nothing valid

    displayWinner(player_choice, computer_choice, stumped)
    gameplay += player_choice + computer_choice
    await artificial_wait_time()
    if(round==1) continue;

    training.push({input:prev.slice(-8), output:player_choice})
    net.train(training.slice(-16), {iterations:100})
    localStorage.setItem('gameplay',gameplay.slice(-8))
    localStorage.setItem('brain', JSON.stringify(training.slice(-16)))
    //this would look at history slices 4 rounds long, with a history of the 16 most recent games
  }
}

    </script>
  </head>
  <body>
    <h3 id="dialogue">Loading</h3>
    <button class="rps" id="rock" onclick="take_turn('R')"><img src="https://images.emojiterra.com/google/android-12l/512px/1faa8.png" /></button>
    <button class="rps" id="paper" onclick="take_turn('P')"><img src="https://logowik.com/content/uploads/images/document-page-emoji7091.logowik.com.webp" /></button>
    <button class="rps" id="scissors" onclick="take_turn('S')"><img src="https://images.emojiterra.com/google/noto-emoji/unicode-16.0/color/512px/2702.png" /></button>
  </body>
</html>
